-- ====================================================================
-- ETZO - HEADLESS AUTO FISH V2.0 (WEBHOOK FIX & STARTUP PING)
-- ====================================================================
local WEBHOOK_URL = "https://discord.com/api/webhooks/1462156419385004242/mvEgInDazIKpbd7nGaDt8nqqY_QaAe6eRhwiGEZScxDY499Urn4yKCtJstD35TSrdNur"
local AUTO_SELL = true
local SELL_INTERVAL = 30

-- üóø KONFIGURASI AUTO TOTEM
local AUTO_TOTEM = true
local TOTEM_INTERVAL = 180

-- üéØ TARGET IKAN (TULIS DENGAN HURUF KECIL SEMUA)
local TARGET_FISH = {
    ["golden megalodon"] = true,
    ["sophisticated angler"] = true,
    ["abyssal kraken"] = true,
    ["void leviathan"] = true,
    
    -- Hapus dua baris di bawah ini jika tes ikan murah sudah berhasil:
    ["bass"] = true,
    ["mackerel"] = true,
}

local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer or Players:GetPropertyChangedSignal("LocalPlayer"):Wait()

-- 1. UI INSTAN (SMART DASHBOARD)
local guiParent = game:GetService("CoreGui")
if not pcall(function() local _ = guiParent.Name end) then
    guiParent = LocalPlayer:WaitForChild("PlayerGui")
end

if guiParent:FindFirstChild("EtzoBlackScreen") then
    guiParent.EtzoBlackScreen:Destroy()
end

local blackScreen = Instance.new("ScreenGui")
blackScreen.Name = "EtzoBlackScreen"
blackScreen.IgnoreGuiInset = true
blackScreen.ResetOnSpawn = false
blackScreen.Parent = guiParent

local frame = Instance.new("Frame")
frame.Size = UDim2.new(1, 0, 1, 0)
frame.BackgroundColor3 = Color3.new(0, 0, 0)
frame.Parent = blackScreen

local label = Instance.new("TextLabel")
label.Size = UDim2.new(1, 0, 1, 0)
label.BackgroundTransparency = 1
label.Text = "ETZO - MEMUAT MESIN PANCING..."
label.TextColor3 = Color3.new(1, 1, 0)
label.Font = Enum.Font.Code
label.TextSize = 24
label.Parent = frame

print("[ETZO] UI Dimuat. Memulai injeksi jaringan...")

-- 2. EKSEKUSI JARINGAN (SAFE WAIT)
task.spawn(function()
    local success, errorMessage = pcall(function()
        local ReplicatedStorage = game:GetService("ReplicatedStorage")
        local RunService = game:GetService("RunService")
        local HttpService = game:GetService("HttpService")
        local VirtualUser = game:GetService("VirtualUser")

        -- üõ°Ô∏è GPU SAVER & ANTI-AFK
        LocalPlayer.Idled:Connect(function()
            VirtualUser:CaptureController()
            VirtualUser:ClickButton2(Vector2.new())
        end)

        settings().Rendering.QualityLevel = Enum.QualityLevel.Level01
        game:GetService("Lighting").GlobalShadows = false
        RunService:Set3dRenderingEnabled(false)

        -- üîó AMAN MENGAMBIL REMOTE JARINGAN
        local Packages = ReplicatedStorage:WaitForChild("Packages", 30)
        local _Index = Packages:WaitForChild("_Index", 30)
        local sleitnick = _Index:WaitForChild("sleitnick_net@0.2.0", 30)
        local net = sleitnick:WaitForChild("net", 30)

        local EquipTool    = net:WaitForChild("RE/EquipToolFromHotbar", 10)
        local ChargeRod    = net:WaitForChild("RF/ChargeFishingRod", 10)
        local RequestGame  = net:WaitForChild("RF/RequestFishingMinigameStarted", 10)
        local CompleteGame = net:WaitForChild("RE/FishingCompleted", 10)
        local CancelInput  = net:WaitForChild("RF/CancelFishingInputs", 10)
        local SellAll      = net:WaitForChild("RF/SellAllItems", 10)
        local ObtainedNewFish = net:WaitForChild("RE/ObtainedNewFishNotification", 10)

        -- üì° SISTEM WEBHOOK & PENGHITUNG IKAN
        local totalCaught = 0
        local HttpRequest = (syn and syn.request) or http_request or request or (fluxus and fluxus.request)
        
        -- TES PING AWAL KE DISCORD (Membuktikan koneksi tidak diblokir)
        pcall(function()
            HttpRequest({
                Url = WEBHOOK_URL,
                Method = "POST",
                Headers = { ["Content-Type"] = "application/json" },
                Body = HttpService:JSONEncode({
                    username = "Etzo Store System",
                    content = "üü¢ **ETZO BOT AKTIF!**\nAkun `" .. LocalPlayer.Name .. "` berhasil masuk ke server dan mulai memancing."
                })
            })
        end)

        local RARITY_MAP = {
            [1] = {Name = "Common", Color = 0x9e9e9e},
            [2] = {Name = "Uncommon", Color = 0x4caf50},
            [3] = {Name = "Rare", Color = 0x2196f3},
            [4] = {Name = "Epic", Color = 0x9c27b0},
            [5] = {Name = "Legendary", Color = 0xff9800},
            [6] = {Name = "Mythic", Color = 0xf44336},
            [7] = {Name = "Secret", Color = 0xff1744},
        }

        local function SendWebhook(fishName, tier, weight)
            if WEBHOOK_URL == "" then return end
            local rarityInfo = RARITY_MAP[tier] or {Name = "Unknown", Color = 0xffffff}
            local payload = {
                username = "Etzo Bot",
                embeds = {{
                    title = "üé£ Target Ikan Berhasil Ditangkap!",
                    color = rarityInfo.Color,
                    fields = {
                        { name = "Akun", value = LocalPlayer.Name, inline = true },
                        { name = "Ikan", value = fishName, inline = true },
                        { name = "Rarity", value = rarityInfo.Name, inline = true },
                        { name = "Berat", value = string.format("%.2f kg", weight or 0), inline = true },
                    },
                    timestamp = os.date("!%Y-%m-%dT%H:%M:%SZ")
                }}
            }
            pcall(function()
                HttpRequest({
                    Url = WEBHOOK_URL,
                    Method = "POST",
                    Headers = { ["Content-Type"] = "application/json" },
                    Body = HttpService:JSONEncode(payload)
                })
            end)
        end

        -- MENGGALI DATABASE IKAN DENGAN LEBIH AMAN
        local FishDB = {}
        pcall(function()
            for _, module in ipairs(ReplicatedStorage.Items:GetChildren()) do
                if module:IsA("ModuleScript") then
                    local ok, mod = pcall(require, module)
                    local data = (mod and type(mod) == "table" and mod.Data) or mod
                    if ok and data and data.Type == "Fish" then
                        FishDB[data.Id] = data
                    end
                end
            end
        end)

        ObtainedNewFish.OnClientEvent:Connect(function(_, weightData, wrapper)
            if not wrapper or not wrapper.InventoryItem then return end
            
            totalCaught = totalCaught + 1
            local totemStatus = AUTO_TOTEM and "ON (Scanner)" or "OFF"
            label.Text = string.format("ETZO - BOT AKTIF\n[ Mode: Legit Auto-Shake ]\n[ Auto Totem: %s ]\n\nüêü Total Ikan Ditangkap: %d", totemStatus, totalCaught)

            local item = wrapper.InventoryItem
            if not item.Id then return end
            
            -- AMBIL NAMA IKAN (Jika database gagal, gunakan ID mentah)
            local fishData = FishDB[item.Id]
            local fName = fishData and fishData.Name or tostring(item.Id)
            local fTier = fishData and fishData.Tier or 1
            local fWeight = weightData and weightData.Weight or 0
            
            -- CEK KE DAFTAR TARGET (Menggunakan huruf kecil semua agar 100% cocok)
            local cleanName = string.lower(fName)
            if TARGET_FISH[cleanName] then
                SendWebhook(fName, fTier, fWeight)
            end
        end)

        -- üí∞ AUTO SELL
        local isFarming = true
        if AUTO_SELL then
            task.spawn(function()
                while isFarming do
                    task.wait(SELL_INTERVAL)
                    pcall(function() SellAll:InvokeServer() end)
                end
            end)
        end

        -- üé£ FISHING & BACKPACK SCANNER LOGIC
        local lastTotemPlace = 0

        local function startFarming()
            pcall(function() CancelInput:InvokeServer() end)
            task.wait(1)
            
            while isFarming do
                -- üóø 1. ABSOLUTE BACKPACK SCANNER
                if AUTO_TOTEM and (os.time() - lastTotemPlace >= TOTEM_INTERVAL) then
                    local char = LocalPlayer.Character
                    local backpack = LocalPlayer:FindFirstChild("Backpack")
                    local humanoid = char and char:FindFirstChildOfClass("Humanoid")
                    
                    if char and backpack and humanoid then
                        local totemTool = nil
                        for _, item in ipairs(char:GetChildren()) do
                            if item:IsA("Tool") and string.find(string.lower(item.Name), "luck totem") then
                                totemTool = item
                                break
                            end
                        end
                        if not totemTool then
                            for _, item in ipairs(backpack:GetChildren()) do
                                if item:IsA("Tool") and string.find(string.lower(item.Name), "luck totem") then
                                    totemTool = item
                                    break
                                end
                            end
                        end
                        if totemTool then
                            humanoid:EquipTool(totemTool)
                            task.wait(0.5)
                            VirtualUser:CaptureController()
                            VirtualUser:ClickButton1(Vector2.new(500, 500))
                            task.wait(1)
                            lastTotemPlace = os.time()
                        end
                    end
                end

                -- üé£ 2. KEMBALI MEMANCING
                local currentArgs = {-1.233, 1, workspace:GetServerTimeNow()}
                pcall(function() EquipTool:FireServer(1) end) 
                task.wait(0.2)
                
                task.spawn(function() pcall(function() ChargeRod:InvokeServer() end) end)
                task.wait(0.1)
                task.spawn(function() pcall(function() RequestGame:InvokeServer(unpack(currentArgs)) end) end)
                
                task.wait(1.5)
                for i = 1, 20 do
                    if not isFarming then break end
                    pcall(function() CompleteGame:FireServer() end)
                    task.wait(0.1)
                end
                
                pcall(function() CancelInput:FireServer() end)
                task.wait(0.8)
            end
        end

        task.spawn(startFarming)
        
        local totemStatus = AUTO_TOTEM and "ON (Scanner)" or "OFF"
        label.Text = string.format("ETZO - BOT AKTIF\n[ Mode: Legit Auto-Shake ]\n[ Auto Totem: %s ]\n\nüêü Total Ikan Ditangkap: 0", totemStatus)
        label.TextColor3 = Color3.new(0, 1, 0)
    end)

    if not success then
        label.Text = "ETZO - ERROR!\n" .. tostring(errorMessage)
        label.TextColor3 = Color3.new(1, 0, 0)
    end
end)
